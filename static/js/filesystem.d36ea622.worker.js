/*! For license information please see filesystem.d36ea622.worker.js.LICENSE.txt */
!function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function t(t,n){if(t){if("string"===typeof t)return e(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}function n(e,n){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=t(e))||n&&e&&"number"===typeof e.length){r&&(e=r);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,c=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return c=e.done,e},e:function(e){s=!0,i=e},f:function(){try{c||null==r.return||r.return()}finally{if(s)throw i}}}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function c(){c=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(P){l=function(e,t,n){return e[t]=n}}function f(e,t,n,a){var o=t&&t.prototype instanceof h?t:h,i=Object.create(o.prototype),c=new F(a||[]);return r(i,"_invoke",{value:E(e,n,c)}),i}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(P){return{type:"throw",arg:P}}}e.wrap=f;var p={};function h(){}function v(){}function y(){}var m={};l(m,o,(function(){return this}));var b=Object.getPrototypeOf,x=b&&b(b(N([])));x&&x!==t&&n.call(x,o)&&(m=x);var w=y.prototype=h.prototype=Object.create(m);function g(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(r,o,c,s){var u=d(e[r],e,o);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==i(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){a("next",e,c,s)}),(function(e){a("throw",e,c,s)})):t.resolve(f).then((function(e){l.value=e,c(l)}),(function(e){return a("throw",e,c,s)}))}s(u.arg)}var o;r(this,"_invoke",{value:function(e,n){function r(){return new t((function(t,r){a(e,n,t,r)}))}return o=o?o.then(r,r):r()}})}function E(e,t,n){var r="suspendedStart";return function(a,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw o;return I()}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var c=S(i,n);if(c){if(c===p)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=d(e,t,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===p)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}function S(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,S(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var r=d(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,p;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function F(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function N(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:I}}function I(){return{value:void 0,done:!0}}return v.prototype=y,r(w,"constructor",{value:y,configurable:!0}),r(y,"constructor",{value:v,configurable:!0}),v.displayName=l(y,u,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,l(e,u,"GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},g(k.prototype),l(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,n,r,a,o){void 0===o&&(o=Promise);var i=new k(f(t,n,r,a),o);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(w),l(w,u,"Generator"),l(w,o,(function(){return this})),l(w,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},e.values=N,F.prototype={constructor:F,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(L),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),s=n.call(o,"finallyLoc");if(c&&s){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;L(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:N(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),p}},e}function s(e,t,n,r,a,o,i){try{var c=e[o](i),s=c.value}catch(u){return void n(u)}c.done?t(s):Promise.resolve(s).then(r,a)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){s(o,r,a,i,c,"next",e)}function c(e){s(o,r,a,i,c,"throw",e)}i(void 0)}))}}function l(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o=[],i=!0,c=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(s){c=!0,a=s}finally{try{i||null==n.return||n.return()}finally{if(c)throw a}}return o}}(e,n)||t(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function p(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function h(e,t,n){return h=p()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var a=new(Function.bind.apply(e,r));return n&&d(a,n.prototype),a},h.apply(null,arguments)}function v(n){return function(t){if(Array.isArray(t))return e(t)}(n)||function(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(n)||t(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var y=Symbol("Comlink.proxy"),m=Symbol("Comlink.endpoint"),b=Symbol("Comlink.releaseProxy"),x=Symbol("Comlink.thrown"),w=function(e){return"object"===typeof e&&null!==e||"function"===typeof e},g=new Map([["proxy",{canHandle:function(e){return w(e)&&e[y]},serialize:function(e){var t=new MessageChannel,n=t.port1,r=t.port2;return k(e,n),[r,[r]]},deserialize:function(e){return e.start(),O(e,[],t);var t}}],["throw",{canHandle:function(e){return w(e)&&x in e},serialize:function(e){var t=e.value;return[t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[]]},deserialize:function(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self;t.addEventListener("message",(function n(r){if(r&&r.data){var a,o=Object.assign({path:[]},r.data),i=o.id,c=o.type,s=o.path,u=(r.data.argumentList||[]).map(T);try{var d=s.slice(0,-1).reduce((function(e,t){return e[t]}),e),p=s.reduce((function(e,t){return e[t]}),e);switch(c){case"GET":a=p;break;case"SET":d[s.slice(-1)[0]]=T(r.data.value),a=!0;break;case"APPLY":a=p.apply(d,u);break;case"CONSTRUCT":var y;a=I(h(p,v(u)));break;case"ENDPOINT":var m=new MessageChannel,b=m.port1,w=m.port2;k(e,w),a=N(b,[b]);break;case"RELEASE":a=void 0;break;default:return}}catch(y){a=f({value:y},x,0)}Promise.resolve(a).catch((function(e){return f({value:e},x,0)})).then((function(e){var r=l(P(e),2),a=r[0],o=r[1];t.postMessage(Object.assign(Object.assign({},a),{id:i}),o),"RELEASE"===c&&(t.removeEventListener("message",n),E(t))}))}})),t.start&&t.start()}function E(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function S(e){if(e)throw new Error("Proxy has been released and is not useable")}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},r=!1,a=new Proxy(n,{get:function(n,o){if(S(r),o===b)return function(){return A(e,{type:"RELEASE",path:t.map((function(e){return e.toString()}))}).then((function(){E(e),r=!0}))};if("then"===o){if(0===t.length)return{then:function(){return a}};var i=A(e,{type:"GET",path:t.map((function(e){return e.toString()}))}).then(T);return i.then.bind(i)}return O(e,[].concat(v(t),[o]))},set:function(n,a,o){S(r);var i=l(P(o),2),c=i[0],s=i[1];return A(e,{type:"SET",path:[].concat(v(t),[a]).map((function(e){return e.toString()})),value:c},s).then(T)},apply:function(n,a,o){S(r);var i=t[t.length-1];if(i===m)return A(e,{type:"ENDPOINT"}).then(T);if("bind"===i)return O(e,t.slice(0,-1));var c=l(L(o),2),s=c[0],u=c[1];return A(e,{type:"APPLY",path:t.map((function(e){return e.toString()})),argumentList:s},u).then(T)},construct:function(n,a){S(r);var o=l(L(a),2),i=o[0],c=o[1];return A(e,{type:"CONSTRUCT",path:t.map((function(e){return e.toString()})),argumentList:i},c).then(T)}});return a}function L(e){var t,n=e.map(P);return[n.map((function(e){return e[0]})),(t=n.map((function(e){return e[1]})),Array.prototype.concat.apply([],t))]}var F=new WeakMap;function N(e,t){return F.set(e,t),e}function I(e){return Object.assign(e,f({},y,!0))}function P(e){var t,r=n(g);try{for(r.s();!(t=r.n()).done;){var a=l(t.value,2),o=a[0],i=a[1];if(i.canHandle(e)){var c=l(i.serialize(e),2);return[{type:"HANDLER",name:o,value:c[0]},c[1]]}}}catch(s){r.e(s)}finally{r.f()}return[{type:"RAW",value:e},F.get(e)||[]]}function T(e){switch(e.type){case"HANDLER":return g.get(e.name).deserialize(e.value);case"RAW":return e.value}}function A(e,t,n){return new Promise((function(r){var a=new Array(4).fill(0).map((function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)})).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===a&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},t),n)}))}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var _=new EventTarget;self.addEventListener("message",(function(e){if("string"===typeof e.data){var t=new CustomEvent("message",{detail:JSON.parse(e.data)});_.dispatchEvent(t)}}));var R={send:function(e){var t=arguments;return u(c().mark((function n(){var r;return c().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.length>1&&void 0!==t[1]?t[1]:{},n.abrupt("return",new Promise(function(){var t=u(c().mark((function t(n){var a;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=j(),postMessage(JSON.stringify({type:e,content:r,id:r.id||a})),_.addEventListener("message",function(){var e=u(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null!==t.detail.id&&t.detail.id===a&&(_.removeEventListener("message",t),n(t.detail.content));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 2:case"end":return n.stop()}}),n)})))()},sendToWorker:function(e){var t=arguments;return u(c().mark((function n(){var r;return c().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.length>1&&void 0!==t[1]?t[1]:{},n.abrupt("return",new Promise((function(t,n){var a=j();void 0!==r.id&&(r.callback=!0),e||void 0!==r.id?(postMessage(JSON.stringify({type:"relay",target:e,content:r,id:r.id||a})),_.addEventListener("message",function(){var e=u(c().mark((function e(n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null!==n.detail.id&&n.detail.id===a&&(_.removeEventListener("message",n),t(n.detail.content));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())):n(new Error("Target must be specified"))})));case 2:case"end":return n.stop()}}),n)})))()},onMessage:_},C=function(){function e(t){var n=this;r(this,e),u(c().mark((function e(){var r,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null,"undefined"!==typeof window){e.next=9;break}return e.next=4,R.send("window");case 4:a=e.sent.window.id,self.id=a.id,r=a.id,e.next=10;break;case 9:r=void 0!==self.id?self.id:window.id;case 10:n.input="".concat(t,"-").concat(r);case 11:case"end":return e.stop()}}),e)})))()}return o(e,[{key:"sha1",value:function(){var e=u(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=Array,e.t1=Uint8Array,e.next=5,crypto.subtle.digest("SHA-1",new TextEncoder("utf-8").encode(this.input));case 5:return e.t2=e.sent,e.t3=new e.t1(e.t2),e.abrupt("return",e.t0.from.call(e.t0,e.t3).map((function(e){return"00".concat(e.toString(16)).slice(-2)})).join(""));case 10:throw e.prev=10,e.t4=e.catch(0),void 0!=="Failed to hash data: ".concat(e.t4.stack)?e.t4.stack:0;case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}()}]),e}();function J(e){try{return JSON.stringify(e)}catch(t){return"{ stringify failed }"}}function M(e){return"string"===typeof e?[e]:"object"!==typeof e||Array.isArray(e)?e.map((function(e){return"object"!==typeof e||Array.isArray(e)?Array.isArray(e)?M(e):e:J(e)})).filter((function(e){return 0!==e.length})).map((function(e){return e.toString()})).map((function(e){return e.replace(/\\"/g,'"')})):[J(e)]}importScripts(["/3rd-party/localforage.js"]);var G=localforage;!function(e){if(!0!==console.rewritten){void 0!==e&&void 0!==e.console||(e={internal:{console:{list:["log","error","info","trace","warn","debug"],cache:{},logs:[],color:{warn:"yellow",error:"red",log:"limegreen",default:"limegreen"}}},isDummy:!0});var t,r=n(e.internal.console.list);try{var a=function(){var n=t.value;e.internal.console.cache[n]=console[n];var r=e.internal.console.color;console[n]=function(){for(var t=arguments.length,a=new Array(t),o=0;o<t;o++)a[o]=arguments[o];if(void 0!==a[0]&&"function"===typeof a[0].startsWith&&a[0].startsWith("[")&&a[0].includes("]")){var i,c,s="".concat(a[0].split("]")[0],"]");a[0]=a[0].split("]")[1],s="%c".concat(s),""!==a[0]&&(a[0]=a[0].trimLeft(),a.splice(0,0,"")),(i=e.internal.console.cache)[n].apply(i,["".concat(s,"%s"),null!==(c="color: ".concat(r[n]))&&void 0!==c?c:"".concat(r.default,";")].concat(a))}else if(a.includes("%c")){var u;(u=e.internal.console.cache)[n].apply(u,a)}else{var l,f,d="%c[ \u2753 ] ";(l=e.internal.console.cache)[n].apply(l,[d,null!==(f="color: ".concat(r[n]))&&void 0!==f?f:"".concat(r.default,";")].concat(a))}if(!e.isDummy){var p=M(a);e.internal.console.logs.push("[ ".concat((new Date).getTime()-e.internal.timeAtLive,"s - ").concat(n.toUpperCase()," ] ").concat(p.join(" "))),e.internal.console.logs.length>1e3&&e.internal.console.logs.shift()}}};for(r.s();!(t=r.n()).done;)a()}catch(o){r.e(o)}finally{r.f()}console.rewritten=!0}}();var W={init:function(){return u(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return W.shared.ready=!0,e.abrupt("return",!0);case 2:case"end":return e.stop()}}),e)})))()},shared:{ready:!1,filesystem_instances:{},id:null}};k(W);var D=function(){function e(t){r(this,e),this.type=parseInt(t,10),this.id=j(),this.index=[],this.data={},W.shared.filesystem_instances[this.id]=this}return o(e,[{key:"validate",value:function(){var e=u(c().mark((function e(t,n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(r,a){var o,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=new C(t),e.next=4,o.sha1();case 4:i=e.sent,console.debug("[ Filesystem ] Checksum calculation",t,n,i),r(n===i),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),a(new Error("Failed to validate checksum: ".concat(e.t0.stack)));case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=u(c().mark((function e(t){var n=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(r,a){var o,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,e.t0=n.type,e.next=0===e.t0?4:19;break;case 4:return console.debug("[ Filesystem ] Preparing read task..."),e.t1=JSON,e.next=8,G.getItem(t);case 8:return e.t2=e.sent,o=e.t1.parse.call(e.t1,e.t2),console.debug("[ Filesystem ] Read raw data:",o),console.debug("[ Filesystem ] Validating checksum..."),i={name:o.name,date:o.date},o.data&&(i.data=o.data),e.next=16,n.validate(JSON.stringify(i),o.checksum);case 16:return e.sent?(console.debug("[ Filesystem ] Checksum valid, read task concluded successfully."),r(o)):a(new Error("Failed to validate read data")),e.abrupt("break",20);case 19:throw new Error("Unknown filesystem type");case 20:e.next=25;break;case 22:e.prev=22,e.t3=e.catch(0),a(new Error("Failed to read: ".concat(e.t3.stack)));case 25:case"end":return e.stop()}}),e,null,[[0,22]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"writeToIndex",value:function(){var e=u(c().mark((function e(t,r,a){var o=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(i,s){var u,l,f,d,p,h,v,y;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!0),console.log("[ Filesystem ] Preparing index update..."),console.debug("[ Filesystem ] Index snapshot before update:",o.index),console.debug("[ Filesystem] Index entry identifier:",t,"data:",r),a){e.next=36;break}if(!0!==t){e.next=30;break}console.debug("[ Filesystem ] Writing to index root..."),u=!1,l=n(o.index),e.prev=9,l.s();case 11:if((f=l.n()).done){e.next=19;break}if(f.value.i!==r.id){e.next=17;break}return u=!0,r,e.abrupt("break",19);case 17:e.next=11;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(9),l.e(e.t0);case 24:return e.prev=24,l.f(),e.finish(24);case 27:u||o.index.push(r),e.next=36;break;case 30:console.debug("[ Filesystem ] Writing to folder..."),d=!1,p=!1,h=function e(t,n){for(var a=0;a<t.length;a++)if(0===t[a].t&&t[a].id===n)d=!0,t[a]=r;else if(1===t[a].t){if(t[a].i===n){for(var o=0;o<t[a].d.length;o++)t[a].d[o].i===r.i&&(d=!0,t[a].d[o]=r);d||(t[a].d.push(r),p=!0);break}e(t[a].d,n)}},h(o.index,t),d||p||s(new Error("Cannot find such location"));case 36:return v=new C(o.index),e.next=39,v.sha1();case 39:y=e.sent,console.debug("[ Filesystem ] Index after update:",o.index),e.t1=o.type,e.next=0===e.t1?44:49;break;case 44:return e.next=46,G.setItem("matikkaeditori-checksums",JSON.stringify(y));case 46:return e.next=48,G.setItem("matikkaeditori-index",JSON.stringify(o.index));case 48:return e.abrupt("break",50);case 49:throw new Error("Unknown filesystem type");case 50:console.log("[ Filesystem ] Index update completed successfully."),i();case 52:case"end":return e.stop()}}),e,null,[[9,21,24,27]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"resolveFromIndex",value:function(){var e=u(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==t){e.next=2;break}return e.abrupt("return",this.index);case 2:return r=function e(r){var a,o=n(r);try{for(o.s();!(a=o.n()).done;){var i=a.value;if(i.i===t)return i;if(1===i.t){var c=e(i.d);if(null!==c)return c}}}catch(s){o.e(s)}finally{o.f()}return null},e.abrupt("return",r(this.index));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"removeFromIndex",value:function(){var e=u(c().mark((function e(t){var r,a=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==t){e.next=2;break}return e.abrupt("return",this.index);case 2:return r=function e(r){var o,i=n(r);try{for(i.s();!(o=i.n()).done;){var c=o.value;if(c.i===t&&(r.splice(r.indexOf(c),1),a.writeToIndex(null,null,!0).then((function(){return!0}))),1===c.t){var s=e(c.d);if(null!==s)return s}}}catch(u){i.e(u)}finally{i.f()}return null},e.abrupt("return",r(this.index));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"limitTreeLevel",value:function(){var e=u(c().mark((function e(t,r){var a,o;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=JSON.parse(JSON.stringify(t)),o=function e(t){var a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=n(t);try{for(i.s();!(a=i.n()).done;){var c=a.value;if(1===c.t){if(r>o)return e(c.d,o+1);c.d=null}}}catch(s){i.e(s)}finally{i.f()}return null},o(a),e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"write",value:function(){var e=u(c().mark((function e(t,n,r){var a=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(o,i){var s,u,l,f,d,p,h,v,y,m,b;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,e.t0=a.type,e.next=0===e.t0?4:40;break;case 4:return console.log("[ Filesystem ] Preparing write task..."),e.t1=JSON,e.next=8,G.getItem(t);case 8:if(e.t2=e.sent,null===(f=e.t1.parse.call(e.t1,e.t2))&&(console.debug("[ Filesystem ] No previous entry found."),f={id:null!==t&&void 0!==t?t:j()}),d={name:null!==(s=n.name)&&void 0!==s?s:f.name,date:null!==(u=n.date)&&void 0!==u?u:(new Date).getTime()},0!==n.type){e.next=21;break}return d.data=null!==(p=n.data)&&void 0!==p?p:f.data,h=new C(JSON.stringify({name:d.name,data:d.data,date:d.date})),e.next=17,h.sha1();case 17:v=e.sent,d.checksum=v,e.next=26;break;case 21:return y=new C(JSON.stringify({name:d.name,date:d.date})),e.next=24,y.sha1();case 24:m=e.sent,d.checksum=m;case 26:return console.debug("[ Filesystem ] Write task base:",d),e.next=29,G.setItem(null!==t&&void 0!==t?t:f.id,JSON.stringify(d));case 29:return b={t:null!==(l=n.type)&&void 0!==l?l:f.type,i:null!==t&&void 0!==t?t:f.id},e.next=32,a.resolveFromIndex(null!==t&&void 0!==t?t:f.id);case 32:if(e.sent){e.next=37;break}return 1===n.type&&(b.d=[]),e.next=37,a.writeToIndex(r,b);case 37:return console.log("[ Filesystem ] Write task completed successfully."),o(null!==t&&void 0!==t?t:f.id),e.abrupt("break",41);case 40:throw new Error("Unknown filesystem type");case 41:e.next=47;break;case 43:e.prev=43,e.t3=e.catch(0),console.debug(e.t3),i(new Error("Failed to write: ".concat(e.t3.stack)));case 47:case"end":return e.stop()}}),e,null,[[0,43]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=u(c().mark((function e(t){var n=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(r,a){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,e.t0=n.type,e.next=0===e.t0?4:24;break;case 4:return console.log("[ Filesystem ] Preparing remove task..."),e.next=7,G.getItem(t);case 7:if(e.t1=e.sent,null===e.t1){e.next=14;break}return console.log("[ Filesystem ] Target",t,"exists"),e.next=12,G.removeItem(t);case 12:e.next=15;break;case 14:console.log("[ Filesystem ] Target not found");case 15:return e.next=17,n.resolveFromIndex(t);case 17:if(e.t2=e.sent,null===e.t2){e.next=21;break}return e.next=21,n.removeFromIndex(t);case 21:return console.log("[ Filesystem ] Remove task concluded"),r(!0),e.abrupt("break",25);case 24:throw new Error("Unknown filesystem type");case 25:e.next=30;break;case 27:e.prev=27,e.t3=e.catch(0),a(new Error("Failed to write: ".concat(e.t3.stack)));case 30:case"end":return e.stop()}}),e,null,[[0,27]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"init",value:function(){var e=u(c().mark((function e(){var t=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=u(c().mark((function e(n,r){var a,o,i,s,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,e.t0=t.type,e.next=0===e.t0?4:36;break;case 4:return e.next=6,G.getItem("matikkaeditori-index");case 6:return a=e.sent,e.next=9,G.getItem("matikkaeditori-checksums");case 9:if(o=e.sent,null===a||null===o){e.next=25;break}return a=JSON.parse(a),o=JSON.parse(o),e.next=15,t.validate(a,o);case 15:if(e.sent){e.next=21;break}return e.next=19,R.send("confirm","Someone may have tampered with index data or it may be corrupt. Would you like to load it?");case 19:e.sent||r(new Error("Filesystem initialization aborted."));case 21:t.index=a,n(),e.next=35;break;case 25:return i=j(),s={name:"Tervetuloa!",date:(new Date).getTime(),data:["<text>VGVydmV0dWxvYSBrw6R5dHTDpG3DpMOkbiBNYXRpa2thZWRpdG9yaS5maXTDpCEg8J+OiQ==</text>"],checksum:null,type:0},u=new C({name:s.name,data:s.data,date:s.date}),e.next=30,u.sha1();case 30:return s.checksum=e.sent,e.next=33,t.write(i,s,!0);case 33:console.log("[ Filesystem ] Example file created"),n();case 35:return e.abrupt("break",37);case 36:throw new Error("Unknown filesystem type");case 37:e.next=43;break;case 39:e.prev=39,e.t1=e.catch(0),r(new Error("Failed to initialize filesystem: \n".concat(e.t1.stack))),console.debug(e.t1);case 43:case"end":return e.stop()}}),e,null,[[0,39]])})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]),e}();R.onMessage.addEventListener("message",function(){var e=u(c().mark((function e(t){var n,r,a,o,i,s,u,l,f,d,p,h,v;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=t.detail,W.shared.ready){e.next=3;break}return e.abrupt("return");case 3:e.t0=t.type,e.next="init"===e.t0?6:"read"===e.t0?12:"write"===e.t0?21:"callback"===e.t0?30:"remove"===e.t0?31:"move"===e.t0?39:"index"===e.t0?63:"reset"===e.t0?81:85;break;case 6:return n=new D(t.content.type),W.shared.filesystem_instances[t.id]=n,e.next=10,n.init();case 10:return R.send("callback",{id:t.id,instance:n.id,index:n.index}),e.abrupt("break",86);case 12:if(r=W.shared.filesystem_instances[t.content.instance]){e.next=16;break}return console.error("No such filesystem instance"),e.abrupt("break",86);case 16:return e.next=18,r.read(t.content.id);case 18:return a=e.sent,R.send("callback",{id:t.id,read:a}),e.abrupt("break",86);case 21:if(o=W.shared.filesystem_instances[t.content.instance]){e.next=25;break}return console.error("No such filesystem instance"),e.abrupt("break",86);case 25:return e.next=27,o.write(t.content.id,t.content.write,t.content.location);case 27:return i=e.sent,R.send("callback",{id:t.id,write:i}),e.abrupt("break",86);case 30:return e.abrupt("break",86);case 31:if(s=W.shared.filesystem_instances[t.content.instance]){e.next=35;break}return console.error("No such filesystem instance"),e.abrupt("break",86);case 35:return e.next=37,s.remove(t.content.id);case 37:return R.send("callback",{id:t.id}),e.abrupt("break",86);case 39:if(u=W.shared.filesystem_instances[t.content.instance]){e.next=43;break}return console.error("No such filesystem instance"),e.abrupt("break",86);case 43:return l=t.content.from,f=t.content.to,e.next=47,u.resolveFromIndex(l);case 47:if(d=e.sent){e.next=51;break}return console.error("No such location (read)"),e.abrupt("break",86);case 51:return e.next=53,u.removeFromIndex(t.content.id);case 53:if(!0===f){e.next=60;break}return e.next=56,u.resolveFromIndex(f);case 56:if(e.sent){e.next=60;break}return console.error("No such location (write)"),e.abrupt("break",86);case 60:return e.next=62,u.writeToIndex(f,d);case 62:return e.abrupt("break",86);case 63:if(p=W.shared.filesystem_instances[t.content.instance]){e.next=67;break}return console.error("No such filesystem instance"),e.abrupt("break",86);case 67:if(!t.content.id||!t.content.level){e.next=79;break}return e.next=70,p.resolveFromIndex(t.content.id);case 70:if(h=e.sent,v=null,null===h){e.next=76;break}return e.next=75,p.limitTreeLevel(!0===t.content.id?h:h.d,t.content.level);case 75:v=e.sent;case 76:R.send("callback",{index:v,id:t.id}),e.next=80;break;case 79:R.send("callback",{index:p.index,id:t.id});case 80:return e.abrupt("break",86);case 81:return e.next=83,G.clear();case 83:return R.send("callback",{id:t.id,status:"ok"}),e.abrupt("break",86);case 85:console.error("[ Filesystem ] Unknown command",t);case 86:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}();
//# sourceMappingURL=filesystem.d36ea622.worker.js.map